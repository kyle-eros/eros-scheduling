name: EROS Scheduling System - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 9 AM PT (5 PM UTC)
    - cron: '0 17 * * *'

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '16'

jobs:
  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort mypy
          if [ -f python/requirements.txt ]; then pip install -r python/requirements.txt; fi

      - name: Run flake8
        run: |
          # Stop on syntax errors or undefined names
          flake8 python/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Check for other issues (treat as warnings)
          flake8 python/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run pylint
        run: |
          pylint python/*.py --exit-zero --max-line-length=127

      - name: Check code formatting with black
        run: |
          black --check python/

      - name: Check import ordering with isort
        run: |
          isort --check-only python/

      - name: Run mypy type checking
        run: |
          mypy python/ --ignore-missing-imports || true

  lint-orchestrator:
    name: Lint Orchestrator Agent
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate Markdown files
        run: |
          # Check for broken links in agent markdown files
          for file in agents/*.md; do
            echo "Checking $file"
            # Basic syntax validation
            if ! grep -q "^# " "$file"; then
              echo "ERROR: $file missing top-level header"
              exit 1
            fi
          done

      - name: Check for Python code blocks in markdown
        run: |
          # Extract and validate Python code blocks from agent files
          for file in agents/*.md; do
            echo "Extracting Python from $file"
            # This is a placeholder - would need proper markdown parser
            grep -A 100 '```python' "$file" | grep -B 100 '```' > /tmp/extracted.py || true
          done

  test-sql-validation:
    name: SQL Validation Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          pip install google-cloud-bigquery pytest

      - name: Validate SQL syntax
        run: |
          # Check SQL files for basic syntax errors
          for file in deployment/*.sql sql/*.sql; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              # Basic SQL syntax checks
              if grep -q "SELET\|FORM\|WEHRE" "$file"; then
                echo "ERROR: Typo found in $file"
                exit 1
              fi
            fi
          done

      - name: Check for SQL injection patterns
        run: |
          # Look for dangerous SQL patterns
          if grep -r "CONCAT.*query\|'+.*+'" deployment/*.sql; then
            echo "WARNING: Potential SQL injection pattern found"
            # Don't fail, just warn
          fi

  dry-run-deployment:
    name: Dry Run Deployment
    runs-on: ubuntu-latest
    needs: [lint-python, lint-orchestrator, test-sql-validation]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          version: 'latest'

      - name: Dry run deployment script
        run: |
          cd deployment
          chmod +x deploy_idempotent.sh
          # Run in dry-run mode (no actual changes)
          ./deploy_idempotent.sh --dry-run --project-id test-project --dataset test_dataset
        env:
          EROS_PROJECT_ID: test-project
          EROS_DATASET: test_dataset

  test-python-units:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov google-cloud-bigquery pandas
          if [ -f python/requirements.txt ]; then pip install -r python/requirements.txt; fi

      - name: Run pytest
        run: |
          cd python
          pytest test_*.py --cov=. --cov-report=xml --cov-report=term -v

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./python/coverage.xml
          flags: unittests
          name: codecov-umbrella

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets in code
        run: |
          # Basic secret detection
          if grep -r "AIza\|AKIA\|sk_live\|sk_test" --include="*.py" --include="*.sh" .; then
            echo "ERROR: Potential secrets found in code"
            exit 1
          fi

  analyze-performance:
    name: Performance Analysis (Dry Run)
    runs-on: ubuntu-latest
    needs: [test-python-units]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install google-cloud-bigquery pandas
          if [ -f python/requirements.txt ]; then pip install -r python/requirements.txt; fi

      - name: Run performance analysis with fixtures
        run: |
          cd python
          # Run schedule builder with test data
          python test_schedule_builder.py > performance_output.txt 2>&1 || true

      - name: Check performance metrics
        run: |
          cd python
          if [ -f performance_output.txt ]; then
            echo "Performance test output:"
            cat performance_output.txt
          fi

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python-units]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install google-cloud-bigquery pytest pandas
          if [ -f python/requirements.txt ]; then pip install -r python/requirements.txt; fi

      - name: Run integration tests (if available)
        run: |
          if [ -f tests/integration_test_suite.py ]; then
            cd tests
            python integration_test_suite.py || echo "Integration tests not fully configured"
          fi

  validate-deployment-package:
    name: Validate Deployment Package
    runs-on: ubuntu-latest
    needs: [dry-run-deployment]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check deployment files exist
        run: |
          required_files=(
            "deployment/deploy_idempotent.sh"
            "deployment/rollback.sh"
            "deployment/logging_config.sh"
            "deployment/stored_procedures.sql"
            "OPERATIONAL_RUNBOOK.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Required file missing: $file"
              exit 1
            fi
          done

      - name: Validate shell scripts
        run: |
          # Check shell scripts for syntax errors
          for script in deployment/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script"
              bash -n "$script" || exit 1
            fi
          done

      - name: Check for deployment documentation
        run: |
          if [ ! -f "deployment/README.md" ]; then
            echo "WARNING: deployment/README.md not found"
          fi

  # DEPLOYMENT JOBS (only on main branch)

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [lint-python, test-sql-validation, test-python-units, security-scan]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_STAGING_CREDENTIALS }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy to staging
        run: |
          cd deployment
          chmod +x deploy_idempotent.sh
          ./deploy_idempotent.sh --project-id ${{ secrets.STAGING_PROJECT_ID }} --dataset eros_staging
        env:
          EROS_PROJECT_ID: ${{ secrets.STAGING_PROJECT_ID }}
          EROS_DATASET: eros_staging

      - name: Run smoke tests
        run: |
          cd tests
          # Run basic smoke tests against staging
          echo "Smoke tests would run here"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint-python, test-sql-validation, test-python-units, security-scan, validate-deployment-package]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://console.cloud.google.com/bigquery?project=${{ secrets.PROD_PROJECT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_PROD_CREDENTIALS }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Create backup before deployment
        run: |
          cd deployment
          chmod +x backup_tables.sh
          ./backup_tables.sh ${{ secrets.PROD_PROJECT_ID }} eros_platform

      - name: Deploy to production
        run: |
          cd deployment
          chmod +x deploy_idempotent.sh
          ./deploy_idempotent.sh \
            --project-id ${{ secrets.PROD_PROJECT_ID }} \
            --dataset eros_platform \
            --skip-backup
        env:
          EROS_PROJECT_ID: ${{ secrets.PROD_PROJECT_ID }}
          EROS_DATASET: eros_platform

      - name: Run validation tests
        run: |
          cd tests
          chmod +x run_validation_tests.sh
          ./run_validation_tests.sh

      - name: Notify deployment success
        if: success()
        run: |
          echo "Production deployment successful"
          # Would integrate with Slack/email notification here

      - name: Rollback on failure
        if: failure()
        run: |
          cd deployment
          chmod +x rollback.sh
          ./rollback.sh
          echo "Production deployment failed - rolled back"

  notify-on-failure:
    name: Notify on Pipeline Failure
    runs-on: ubuntu-latest
    needs: [lint-python, test-sql-validation, test-python-units, security-scan]
    if: failure()
    steps:
      - name: Send notification
        run: |
          echo "Pipeline failed - notifications would be sent here"
          # Integration points:
          # - Slack webhook
          # - Email
          # - PagerDuty
          # - Custom notification system
