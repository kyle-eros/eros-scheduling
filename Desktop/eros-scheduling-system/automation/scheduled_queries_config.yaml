# =============================================================================
# EROS SCHEDULING SYSTEM - BIGQUERY SCHEDULED QUERIES CONFIGURATION
# =============================================================================
# Project: of-scheduler-proj
# Dataset: eros_scheduling_brain
# Purpose: Configuration for all automated BigQuery scheduled queries
# =============================================================================

scheduled_queries:
  # ---------------------------------------------------------------------------
  # Query 1: Performance Feedback Loop
  # ---------------------------------------------------------------------------
  # Updates caption performance metrics every 6 hours based on message history
  # This is the learning mechanism that adapts caption selection over time

  - name: "eros-performance-feedback-loop"
    display_name: "EROS: Caption Performance Updates"
    query: "CALL `of-scheduler-proj.eros_scheduling_brain.update_caption_performance`()"
    schedule: "every 6 hours"
    timezone: "America/Los_Angeles"
    description: |
      Updates caption performance metrics from mass_messages data.
      Calculates success/failure rates using Wilson score bounds.
      Runs every 6 hours to provide continuous learning feedback.
    notification_config:
      email_on_failure: true
      email_addresses:
        - "devops@yourcompany.com"
        - "data-team@yourcompany.com"
    max_retries: 3
    retry_delay_seconds: 300
    enabled: true
    priority: "HIGH"

  # ---------------------------------------------------------------------------
  # Query 2: Daily Automation Orchestrator
  # ---------------------------------------------------------------------------
  # Main orchestration procedure that runs once per day at 3:05 AM
  # Analyzes all active creators and generates schedules

  - name: "eros-daily-automation"
    display_name: "EROS: Daily Schedule Generation"
    query: "CALL `of-scheduler-proj.eros_scheduling_brain.run_daily_automation`(CURRENT_DATE('America/Los_Angeles'))"
    schedule: "every day 03:05"
    timezone: "America/Los_Angeles"
    description: |
      Daily orchestrator for schedule generation across all active creators.
      - Analyzes creator performance
      - Checks saturation levels
      - Triggers schedule generation queue
      - Cleans up expired locks
      Runs at 3:05 AM LA time to complete before business hours.
    notification_config:
      email_on_failure: true
      email_on_warning: true
      email_addresses:
        - "devops@yourcompany.com"
        - "scheduling-alerts@yourcompany.com"
    max_retries: 2
    retry_delay_seconds: 600
    enabled: true
    priority: "CRITICAL"

  # ---------------------------------------------------------------------------
  # Query 3: Caption Lock Cleanup
  # ---------------------------------------------------------------------------
  # Hourly cleanup of expired caption locks to prevent table bloat
  # Deactivates locks past their scheduled date or older than 7 days

  - name: "eros-lock-cleanup"
    display_name: "EROS: Caption Lock Cleanup"
    query: "CALL `of-scheduler-proj.eros_scheduling_brain.sweep_expired_caption_locks`()"
    schedule: "every 1 hours"
    timezone: "America/Los_Angeles"
    description: |
      Hourly cleanup of expired caption assignment locks.
      - Deactivates locks past scheduled send date
      - Deactivates stale locks (>7 days old)
      - Monitors for lock table bloat
      Prevents the active_caption_assignments table from growing unbounded.
    notification_config:
      email_on_failure: true
      email_addresses:
        - "devops@yourcompany.com"
    max_retries: 3
    retry_delay_seconds: 180
    enabled: true
    priority: "MEDIUM"

  # ---------------------------------------------------------------------------
  # Query 4: Health Check Monitor (Optional)
  # ---------------------------------------------------------------------------
  # Runs every 4 hours to check system health and send proactive alerts

  - name: "eros-health-monitor"
    display_name: "EROS: System Health Monitor"
    query: |
      -- Check for stale data and system issues
      DECLARE stale_performance_check TIMESTAMP;
      DECLARE stale_automation_check TIMESTAMP;

      SET stale_performance_check = (
        SELECT MAX(last_updated)
        FROM `of-scheduler-proj.eros_scheduling_brain.caption_bandit_stats`
      );

      SET stale_automation_check = (
        SELECT MAX(job_start_time)
        FROM `of-scheduler-proj.eros_scheduling_brain.etl_job_runs`
        WHERE job_name = 'daily_automation'
      );

      -- Alert if performance updates are stale (>8 hours)
      IF TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), stale_performance_check, HOUR) > 8 THEN
        INSERT INTO `of-scheduler-proj.eros_scheduling_brain.automation_alerts`
          (alert_time, alert_level, alert_source, alert_message)
        VALUES
          (CURRENT_TIMESTAMP(), 'WARNING', 'health_monitor',
           FORMAT('Performance feedback stale: last update was %d hours ago',
                  TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), stale_performance_check, HOUR)));
      END IF;

      -- Alert if daily automation hasn't run (>28 hours)
      IF TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), stale_automation_check, HOUR) > 28 THEN
        INSERT INTO `of-scheduler-proj.eros_scheduling_brain.automation_alerts`
          (alert_time, alert_level, alert_source, alert_message)
        VALUES
          (CURRENT_TIMESTAMP(), 'CRITICAL', 'health_monitor',
           FORMAT('Daily automation has not run in %d hours',
                  TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), stale_automation_check, HOUR)));
      END IF;
    schedule: "every 4 hours"
    timezone: "America/Los_Angeles"
    description: |
      Proactive health monitoring for the EROS system.
      Checks for stale data and missing scheduled runs.
      Generates alerts for investigation.
    notification_config:
      email_on_failure: true
      email_addresses:
        - "devops@yourcompany.com"
    max_retries: 2
    retry_delay_seconds: 300
    enabled: true
    priority: "LOW"

# =============================================================================
# DEPLOYMENT NOTES
# =============================================================================
#
# To deploy these scheduled queries, use the companion script:
#   ./deploy_scheduled_queries.sh
#
# Manual deployment using bq CLI:
#   bq mk --transfer_config \
#     --project_id=of-scheduler-proj \
#     --data_source=scheduled_query \
#     --target_dataset=eros_scheduling_brain \
#     --display_name="EROS: Caption Performance Updates" \
#     --schedule="every 6 hours" \
#     --params='{"query":"CALL `of-scheduler-proj.eros_scheduling_brain.update_caption_performance`()"}'
#
# To list existing scheduled queries:
#   bq ls --transfer_config --transfer_location=us --project_id=of-scheduler-proj
#
# To update a scheduled query:
#   bq update --transfer_config <config_id> --schedule="new schedule"
#
# To disable a scheduled query:
#   bq update --transfer_config <config_id> --no_enable_refresh
#
# =============================================================================
